<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Gestión Nacionalidades</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f6f8fa; }
  .card { background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); max-width: 900px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; }
  .btn { padding:8px 12px; margin:6px 6px 6px 0; border:none; border-radius:6px; color:#fff; cursor:pointer; }
  .add { background:#16a34a } .save { background:#0ea5e9 } .edit { background:#f59e0b }
  .consult { background:#7c3aed } .cancel { background:#ef4444 } .exit { background:#475569 }
  table { width:100%; border-collapse:collapse; margin-top:14px; }
  th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
  th { background:#0f172a; color:#fff; }
  tr:hover { background:#f1f5f9; cursor:pointer; }
  #msg { margin-top:10px; color:#065f46; font-weight:600; }
</style>
</head>
<body>
  <div class="card">
    <h2>Gestion Nacionalidades</h2>

    <label>Nombre País:</label>
    <input id="nombrePais" type="text" />

    <label>Nombre Nacionalidad:</label>
    <input id="nombreNacionalidad" type="text" />

    <div style="margin-top:10px;">
      <button class="btn add" id="btnAgregar">Agregar</button>
      <button class="btn save" id="btnGrabar">Grabar</button>
      <button class="btn edit" id="btnModificar">Modificar</button>
      <button class="btn consult" id="btnConsultar">Consultar</button>
      <button class="btn cancel" id="btnCancelar">Cancelar</button>
      <button class="btn exit" id="btnSalir">Salir</button>
    </div>

    <div id="msg"></div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3>Listado de Paises y Nacionalidades</h3>
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>País</th>
          <th>Nacionalidad</th>
          <th>Usuario</th>
          <th>WS</th>
          <th>Tiempo</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
const API_BASE = "";
let modo = null; // "agregar" o "modificar"
let codigoSeleccionado = null;

// Mostrar mensajes
function showMsg(text, isError=false) {
  const el = document.getElementById("msg");
  el.style.color = isError ? "#b91c1c" : "#065f46";
  el.textContent = text;
  setTimeout(()=>{ if(!isError) el.textContent=""; }, 3500);
}

// Limpiar solo inputs, sin tocar codigoSeleccionado
function limpiarCampos() {
  document.getElementById("nombrePais").value = "";
  document.getElementById("nombreNacionalidad").value = "";
  modo = null;
  showMsg("");
}

// Limpiar todo (inputs + selección)
function limpiarTodo() {
  limpiarCampos();
  codigoSeleccionado = null;
}

// Consultar y cargar grilla
async function consultar() {
  try {
    const res = await fetch(API_BASE + "/nacionalidades");
    const data = await res.json();
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.CodigoPais}</td>
                      <td>${r.NombrePais}</td>
                      <td>${r.NombreNacionalidad}</td>
                      <td>${r.Usuario ?? ""}</td>
                      <td>${r.WS ?? ""}</td>
                      <td>${r.Tiempo ?? ""}</td>`;
      tr.onclick = () => {
        codigoSeleccionado = r.CodigoPais;
        document.getElementById("nombrePais").value = r.NombrePais;
        document.getElementById("nombreNacionalidad").value = r.NombreNacionalidad;
        showMsg(`Fila ${r.CodigoPais} seleccionada`);
      };
      tbody.appendChild(tr);
    });
    showMsg("Listado actualizado");
  } catch (e) {
    showMsg("Error al consultar: " + e.message, true);
  }
}

// Botones
document.getElementById("btnAgregar").onclick = () => {
  limpiarCampos();
  modo = "agregar";
  showMsg("Modo AGREGAR: complete los campos y presione GRABAR");
};

document.getElementById("btnModificar").onclick = () => {
  if (!codigoSeleccionado) return showMsg("Seleccione una fila de la grilla primero", true);
  modo = "modificar";
  showMsg("Modo MODIFICAR: edite campos y presione GRABAR");
};

document.getElementById("btnGrabar").onclick = async () => {
  const nombrepais = document.getElementById("nombrePais").value.trim();
  const nombrenacionalidad = document.getElementById("nombreNacionalidad").value.trim();
  if (!nombrepais || !nombrenacionalidad) return showMsg("Complete ambos campos", true);

  try {
    if (modo === "agregar") {
      const res = await fetch(API_BASE + "/nacionalidades", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nombrepais, nombrenacionalidad })
      });
      const j = await res.json();
      if (!res.ok) return showMsg("Error al grabar: " + (j.detail || JSON.stringify(j)), true);
      showMsg("Grabado OK (Código: " + (j.CodigoPais || "") + ")");
      limpiarCampos();
    } else if (modo === "modificar") {
      if (!codigoSeleccionado) return showMsg("Seleccione registro para modificar", true);
      const res = await fetch(API_BASE + "/nacionalidades/" + codigoSeleccionado, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nombrepais, nombrenacionalidad })
      });
      const j = await res.json();
      if (!res.ok) return showMsg("Error al modificar: " + (j.detail || JSON.stringify(j)), true);
      showMsg("Modificado correctamente");
      limpiarCampos();
    } else {
      return showMsg("Primero pulse AGREGAR o MODIFICAR", true);
    }

    // Refrescar grilla
    await consultar();
  } catch (e) {
    showMsg("Error al grabar: " + e.message, true);
  }
};

document.getElementById("btnConsultar").onclick = consultar;
document.getElementById("btnCancelar").onclick = () => { limpiarTodo(); showMsg("Operación cancelada"); };
document.getElementById("btnSalir").onclick = () => { showMsg("Cierre la ventana del navegador para salir"); };

// Carga inicial
consultar();
</script>
</body>
</html>